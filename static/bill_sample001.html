<!DOCTYPE html>
<html lang="ja">
    <head>
        <title>請求書サンプル 001</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box;}
            body {font-size: 12px;}
            form {display: flex; flex-direction: column;}
            div.form-data, div.form-data2 {display: flex; flex-direction: row;}
            label.group-title {font-weight: bolder; color: blue;}
            div.data-group1, div.data-group2, div.data-group3, div.bill-details {margin-top: 2em;}
            div.form-data:not(:first-child), div.form-data2:not(:first-child) {margin-top: 0.5em;}
            div.form-data > label, div.form-data2 > label:first-child {width: 8em; text-align: right; margin-right: 1em;}
            div.ope_buttons {margin-top: 2em; display: flex; flex-direction: row; justify-content: center;}
            div.ope_buttons > input {width: 6em;}
            p.spacer1 {width: 2em;}
            div.form-data2 > input {margin-right: 0.5em;}
            div.form-data2 > input+label {width: 6em;}
            div.detail-title {margin-top: 0.5em;}
            div.detail-title, div.detail-data {margin-left: 9em; display: flex; flex-direction: row;}
            div.detail-title > p {font-weight: bold; text-align: center;}
            div.detail-title > p:nth-child(1) {width: 3em;}
            div.detail-title > p:nth-child(2) {width: 20em;}
            div.detail-title > p:nth-child(3) {width: 5em;}
            div.detail-title > p:nth-child(4) {width: 5em;}
            div.detail-title > p:nth-child(5) {width: 5em;}
            div.detail-title > p:nth-child(6) {width: 8em;}
            div.detail-title > p:nth-child(7), div.totals input {width: 8em;}
            div.detail-title > p:not(:last-child) {border-left: 1px solid black; border-bottom: 1px solid black; border-top: 1px solid black;}
            div.detail-title > p:last-child {border: 1px solid black;}
            div.detail-data > p {text-align: center; border: 1px solid black;}
            div.detail-data > p:nth-child(1) {width: 3em; font-size: 12px;}
            div.detail-data > input:nth-child(2) {width: 20em; font-size: 12px;}
            div.detail-data > input:nth-child(3) {width: 5em; font-size: 12px;}
            div.detail-data > input:nth-child(4) {width: 5em; font-size: 12px;}
            div.detail-data > select {width: 5em; font-size: 12px;}
            div.detail-data > input:nth-child(6) {width: 8em; font-size: 12px;}
            div.detail-data > input:nth-child(7) {width: 8em; font-size: 12px;}
            div.totals {margin-left: 46em; margin-top: 0.5em;}
            div.totals input {font-size: 12px;}
        </style>
    </head>
    <body>
        <h3>請求書サンプル 001 入力フォーム</h3>
        <form method="post" action="/b001/preview">
            <div class="data-group2">
                <div class="form-data">
                    <label class="group-title">発行者情報</label>
                </div>
                <div class="form-data">
                    <label for="data21">請求者名</label><input type="text" id="data21" name="data21">
                </div>
                <div class="form-data">
                    <label for="data22">郵便番号</label><input type="text" id="data22" name="data22">
                </div>
                <div class="form-data">
                    <label for="data23">住所１</label><input type="text" id="data23" name="data23">
                </div>
                <div class="form-data">
                    <label for="data24">住所２</label><input type="text" id="data24" name="data24">
                </div>
                <div class="form-data">
                    <label for="data25">住所３</label><input type="text" id="data25" name="data25">
                </div>
                <div class="form-data">
                    <label for="data26">電話番号</label><input type="tel" id="data26" name="data26" pattern="[0-9]+-[0-9]+-[0-9]+">
                </div>
                <div class="form-data">
                    <label for="data27">担当</label><input type="text" id="data27" name="data27">
                </div>
            </div>
            <div class="data-group3">
                <div class="form-data">
                    <label class="group-title">振込先情報</label>
                </div>
                <div class="form-data">
                    <label for="data31">金融機関名</label><input type="text" id="data31" name="data31">
                </div>
                <div class="form-data">
                    <label for="data32">支店名</label><input type="text" id="data32" name="data32">
                </div>
                <div class="form-data">
                    <label for="data33">口座種別</label>
                    <select id="data33" name="data33">
                        <option value="普通" selected>普通</option>
                        <option value="当座">当座</option>
                        <option value="総合">総合</option>
                    </select>
                </div>
                <div class="form-data">
                    <label for="data34">口座番号</label><input type="text" id="data34" name="data34">
                </div>
            </div>
            <div class="data-group1">
                <div class="form-data">
                    <label class="group-title">請求情報</label>
                </div>
                <div class="form-data">
                    <label for="data11">請求先</label><input type="text" id="data11" name="data11">
                </div>
                <div class="form-data">
                    <label for="data12">請求No</label><input type="text" id="data12" name="data12">
                </div>
                <div class="form-data">
                    <label for="data13">請求日</label><input type="date" id="data13" name="data13">
                </div>
                <div class="form-data">
                    <label for="data14">支払期限</label><input type="date" id="data14" name="data14">
                </div>
                <div class="form-data">
                    <label for="data15">件名</label><input type="text" id="data15" name="data15">
                </div>
            </div>
            <div class="bill-details">
                <div class="form-data">
                    <label class="group-title">請求書明細</label>
                </div>
                <div class="form-data2">
                    <label>消費税計算</label>
                    <input type="radio" id="calc-by-total" name="tax-calc" value="by-total" checked/> <label for="calc-by-total">総額</label>
                    <input type="radio" id="calc-pile-up"  name="tax-calc" value="pile-up"/> <label for="calc-pile-up">積上げ</label>
                </div>
                <div class="form-data2">
                    <label>単価</label>
                    <input type="radio" id="with-tax"    name="tax-inc" value="include" checked/> <label for="with-tax">税込み</label>
                    <input type="radio" id="without-tax" name="tax-inc" value="without"/> <label for="without-tax">税抜き</label>
                </div>
                <div class="form-data2">
                    <label>税の端数処理</label>
                    <input type="radio" id="flac-round-off" name="tax-flaction" value="round-off" checked/> <label for="flac-round-off">四捨五入</label>
                    <input type="radio" id="flac-roud-up"   name="tax-flaction" value="roud-up"/> <label for="flac-roud-up">切上げ</label>
                    <input type="radio" id="flac-truncate"  name="tax-flaction" value="truncate"/> <label for="flac-truncate">切捨て</label>
                </div>
                <div class="detail-title">
                    <p>No.</p>
                    <p>摘要</p>
                    <p>数量</p>
                    <p>単位</p>
                    <p>税率</p>
                    <p>単価</p>
                    <p>金額</p>
                </div>
                <div class="detail-data">
                    <p>1</p>
                    <input type="text" name="details[0][name]">
                    <input type="text" name="details[0][number]" class="detail-number">
                    <input type="text" name="details[0][unit_type]">
                    <select name="details[0][tax-rate]" class="tax-rate" id="tax-selector-01">
                        <option value="none"></option>
                        <option value="10">10%</option>
                        <option value="8">8%</option>
                    </select>
                    <input type="text" name="details[0][unit_amount]" class="detail-unit-amount">
                    <input type="text" name="details[0][amount]" class="detail-amount" readonly>
                </div>
                <div class="detail-data">
                    <p>2</p>
                    <input type="text" name="details[1][name]">
                    <input type="text" name="details[1][number]" class="detail-number">
                    <input type="text" name="details[1][unit_type]">
                    <select name="details[1][tax-rate]" class="tax-rate" id="tax-selector-02">
                        <option value="none"></option>
                        <option value="10">10%</option>
                        <option value="8">8%</option>
                    </select>
                    <input type="text" name="details[1][unit_amount]" class="detail-unit-amount">
                    <input type="text" name="details[1][amount]" class="detail-amount" readonly>
                </div>
                <div class="detail-data">
                    <p>3</p>
                    <input type="text" name="details[2][name]">
                    <input type="text" name="details[2][number]" class="detail-number">
                    <input type="text" name="details[2][unit_type]">
                    <select name="details[2][tax-rate]" class="tax-rate" id="tax-selector-03">
                        <option value="none"></option>
                        <option value="10">10%</option>
                        <option value="8">8%</option>
                    </select>
                    <input type="text" name="details[2][unit_amount]" class="detail-unit-amount">
                    <input type="text" name="details[2][amount]" class="detail-amount" readonly>
                </div>
                <div class="detail-data">
                    <p>4</p>
                    <input type="text" name="details[3][name]">
                    <input type="text" name="details[3][number]" class="detail-number">
                    <input type="text" name="details[3][unit_type]">
                    <select name="details[3][tax-rate]" class="tax-rate" id="tax-selector-04">
                        <option value="none"></option>
                        <option value="10">10%</option>
                        <option value="8">8%</option>
                    </select>
                    <input type="text" name="details[3][unit_amount]" class="detail-unit-amount">
                    <input type="text" name="details[3][amount]" class="detail-amount" readonly>
                </div>
                <div class="detail-data">
                    <p>5</p>
                    <input type="text" name="details[4][name]">
                    <input type="text" name="details[4][number]" class="detail-number">
                    <input type="text" name="details[4][unit_type]">
                    <select name="details[4][tax-rate]" class="tax-rate" id="tax-selector-05">
                        <option value="none"></option>
                        <option value="10">10%</option>
                        <option value="8">8%</option>
                    </select>
                    <input type="text" name="details[4][unit_amount]" class="detail-unit-amount">
                    <input type="text" name="details[4][amount]" class="detail-amount" readonly>
                </div>
                <div class="detail-data">
                    <p>6</p>
                    <input type="text" name="details[5][name]">
                    <input type="text" name="details[5][number]" class="detail-number">
                    <input type="text" name="details[5][unit_type]">
                    <select name="details[5][tax-rate]" class="tax-rate" id="tax-selector-06">
                        <option value="none"></option>
                        <option value="10">10%</option>
                        <option value="8">8%</option>
                    </select>
                    <input type="text" name="details[5][unit_amount]" class="detail-unit-amount">
                    <input type="text" name="details[5][amount]" class="detail-amount" readonly>
                </div>
                <div class="detail-data">
                    <p>7</p>
                    <input type="text" name="details[6][name]">
                    <input type="text" name="details[6][number]" class="detail-number">
                    <input type="text" name="details[6][unit_type]">
                    <select name="details[6][tax-rate]" class="tax-rate" id="tax-selector-07">
                        <option value="none"></option>
                        <option value="10">10%</option>
                        <option value="8">8%</option>
                    </select>
                    <input type="text" name="details[6][unit_amount]" class="detail-unit-amount">
                    <input type="text" name="details[6][amount]" class="detail-amount" readonly>
                </div>
                <div class="detail-data">
                    <p>8</p>
                    <input type="text" name="details[7][name]">
                    <input type="text" name="details[7][number]" class="detail-number">
                    <input type="text" name="details[7][unit_type]">
                    <select name="details[7][tax-rate]" class="tax-rate" id="tax-selector-08">
                        <option value="none"></option>
                        <option value="10">10%</option>
                        <option value="8">8%</option>
                    </select>
                    <input type="text" name="details[7][unit_amount]" class="detail-unit-amount">
                    <input type="text" name="details[7][amount]" class="detail-amount" readonly>
                </div>
                <div class="detail-data">
                    <p>9</p>
                    <input type="text" name="details[8][name]">
                    <input type="text" name="details[8][number]" class="detail-number">
                    <input type="text" name="details[8][unit_type]">
                    <select name="details[8][tax-rate]" class="tax-rate" id="tax-selector-09">
                        <option value="none"></option>
                        <option value="10">10%</option>
                        <option value="8">8%</option>
                    </select>
                    <input type="text" name="details[8][unit_amount]" class="detail-unit-amount">
                    <input type="text" name="details[8][amount]" class="detail-amount" readonly>
                </div>
                <div class="detail-data">
                    <p>10</p>
                    <input type="text" name="details[9][name]">
                    <input type="text" name="details[9][number]" class="detail-number">
                    <input type="text" name="details[9][unit_type]">
                    <select name="details[9][tax-rate]" class="tax-rate" id="tax-selector-10">
                        <option value="none"></option>
                        <option value="10">10%</option>
                        <option value="8">8%</option>
                    </select>
                    <input type="text" name="details[9][unit_amount]" class="detail-unit-amount">
                    <input type="text" name="details[9][amount]" class="detail-amount" readonly>
                </div>
            </div>
            <div class="totals">
                <div class="form-data">
                    <label for="total10">小計(10%)</label><input type="text" id="total10" name="total10" />
                </div>
                <div class="form-data">
                    <label for="total8">小計(8%)</label><input type="text" id="total8" name="total8" />
                </div>
                <div class="form-data">
                    <label for="tax10">税額(10%)</label><input type="text" id="tax10" name="tax10" />
                </div>
                <div class="form-data">
                    <label for="tax8">税額(8%)</label><input type="text" id="tax8" name="tax8" />
                </div>
                <div class="form-data">
                    <label for="total">合計</label><input type="text" id="total" name="total" />
                </div>
            </div>
            <div class="ope_buttons">
                <input type="submit" value="プレビュー"/>
                <p class="spacer1"></p>
                <input type="reset" value="クリア"/>
            </div>
        </form>
        <script type="text/javascript">
            let _tax_info = {'tax-calc': 'by-total', 'tax-inc': 'include', 'tax-flaction': 'round-off'}

            /**
             * 税率が同じ金額を集計する。
             * @param tax_rate 税率(8, 10)
             * @return 合計金額
             */
            function _addAmountByTax(tax_rate) {
                let total = 0;
                let count = 0;
                let elms = document.getElementsByClassName('detail-data');
                try {
                    for (var index = 0; index < elms.length; ++index) {
                        var divElm = elms[index];
                        var taxElm = _getDetailTaxRate(divElm);
                        if (taxElm === null) continue;
                        if (parseInt(taxElm.value) !== tax_rate) continue;
                        var amount = _getDetailAmountElement(divElm);
                        total += parseInt(amount.value);
                        ++count;
                    }
                    if (count > 0) return total;
                    return null;
                } catch (ex) {
                    alert('税率での集計 : ' + ex);
                }
            }
            function _taxFlaction(value) {
                switch (_tax_info['tax-flaction']) {
                    case 'round-off':   // 四捨五入
                        return Math.round(value);
                    case 'roud-up':     // 切上げ
                        return Math.ceil(value);
                    case 'truncate':    // 切捨て
                        return Math.floor(value);
                    default:
                        return value;
                }
            }
            function _taxByTotal(total, taxRate) {
                let element = document.getElementById('tax' + taxRate);
                if (total === null) {
                    element.value = '';
                    return null;
                }
                let tax = 0;
                if (_tax_info['tax-inc'] === 'include') {           // 税込単価
                    tax = total - total / ((100.0 + taxRate) / 100.0);
                } else if (_tax_info['tax-inc'] === 'without') {    // 税抜単価
                    tax = total * taxRate / 100.0;
                }
                tax = _taxFlaction(tax);
                element.value = String(tax);
                return tax;
            }
            function _totalByTaxRate(taxRate) {
                let total = _addAmountByTax(taxRate);
                let element = document.getElementById('total' + taxRate);
                element.value = (total !== null ? String(total) : '');
                return total;
            }
            function _calcTotal() {
                try {
                    let taxRateList = [10, 8];
                    let total = 0;
                    for (taxRate of taxRateList) {
                        let a = _totalByTaxRate(taxRate);
                        if (a !== null) total += a;
                        let tax = _taxByTotal(a, taxRate);
                        if ((tax !== null) && (_tax_info['tax-inc'] === 'without'))  total += tax;
                    }
                    let element = document.getElementById('total');
                    element.value = String(total);
                } catch (ex) {
                    alert('合計計算 : ' + ex);
                }
            }
            function _getDetailNumberElement(parent) {
                let es = parent.getElementsByClassName('detail-number');
                return es[0];
            }
            function _getDetailUnitAmountElement(parent) {
                let es = parent.getElementsByClassName('detail-unit-amount');
                return es[0];
            }
            function _getDetailAmountElement(parent) {
                let es = parent.getElementsByClassName('detail-amount');
                return es[0];
            }
            function _getDetailTaxRate(parent) {
                let es = parent.getElementsByClassName('tax-rate');
                return es[0];
            }
            /**
             * 金額を計算する。
             * @param target 入力を行ったエレメント
             * @param isNum  数量の入力の場合、true
             */
            function _calcAmount(target, isNum) {
                try {
                    // 入力を行った要素の値を取得
                    let v1s = target.value;
                    if (isNaN(v1s) || v1s.length < 1) return;
                    let v1 = parseInt(v1s);
                    let elm;
                    let parent = target.parentNode;
                    if (isNum) {    // 数量の入力の場合、単価の入力要素を決定
                        elm = _getDetailUnitAmountElement(parent);
                    } else {        // 単価の入力を行った場合、数量の入力要素を決定
                        elm = _getDetailNumberElement(parent);
                    }
                    let v2s = elm.value;
                    if (isNaN(v2s) || v2s.length < 1) return;
                    let v2 = parseInt(v2s);
                    // 金額の入力要素を決定
                    var v3e = _getDetailAmountElement(parent);
                    // 金額を設定
                    v3e.value = String(v1 * v2);
                    // alert(v1 * v2 + '');
                    _calcTotal();       // 合計欄の更新
                } catch(ex) {
                    alert('金額計算 : ' + ex);
                }
            }
            window.onload = function() {
                var today = new Date();
                document.getElementById('data13').value =
                    today.getFullYear() + '-'
                    + ('0' + (today.getMonth()+1)).slice(-2) + '-'
                    + ('0' + today.getDate()).slice(-2);
                // 数量
                let elmts = document.getElementsByClassName('detail-number');
                for (let idx = 0; idx < elmts.length; ++idx) {
                    elmts[idx].addEventListener('blur', (event) => {
                        _calcAmount(event.target, true);
                    });
                }
                // 単価
                elmts = document.getElementsByClassName('detail-unit-amount');
                for (let idx = 0; idx < elmts.length; ++idx) {
                    elmts[idx].addEventListener('blur', (event) => {
                        _calcAmount(event.target, false);
                    });
                }
                // 消費税計算（総額／積上げ）
                document.getElementsByName('tax-calc').forEach(elmt => {
                    elmt.addEventListener('click', (event) => {
                        _tax_info['tax-calc'] = event.target.value;
                    });
                });
                // 単価（税込／税抜）
                document.getElementsByName('tax-inc').forEach(elmt => {
                    elmt.addEventListener('click', (event) => {
                        _tax_info['tax-inc'] = event.target.value;
                    });
                });
                // 端数処理（四捨五入／切上げ／切捨て）
                document.getElementsByName('tax-flaction').forEach(elmt => {
                    elmt.addEventListener('click', (event) => {
                        _tax_info['tax-flaction'] = event.target.value;
                    });
                });
            }
        </script>
    </body>
</html>